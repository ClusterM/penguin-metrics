# Penguin Metrics Configuration
# Linux system telemetry for Home Assistant via MQTT
#
# Nginx-like syntax with blocks and directives.
# Supports includes: include "/path/to/other.conf";
#
# All options are documented with default values and explanations.

# =============================================================================
# AUTO-REFRESH (Top-level setting)
# =============================================================================
# Periodically check for new/removed services, containers, and processes.
# When enabled, automatically adds new sources matching filters and removes
# disappeared sources. Home Assistant sensors are updated dynamically.
# Default: 0 (disabled)
# auto_refresh_interval 60s;

# =============================================================================
# MQTT BROKER CONNECTION
# =============================================================================
mqtt {
    # Broker address (required)
    host "localhost";              # Default: "localhost"
    port 1883;                     # Default: 1883
    
    # Authentication (optional)
    # username "user";             # Default: None (no auth)
    # password "pass";             # Default: None (no auth)
    
    # Client identification
    # client_id "penguin_metrics"; # Default: auto-generated (hostname-based)
    
    # Topic configuration
    topic_prefix "penguin_metrics"; # Default: "penguin_metrics"
    qos 1;                         # Default: 1 (0, 1, or 2)
    
    # Message retention
    # - off: don't retain any messages
    # - on:  retain all messages (default)
    retain on;                     # Default: on
    
    # Connection keepalive
    keepalive 60;                   # Default: 60 seconds
}

# =============================================================================
# HOME ASSISTANT INTEGRATION
# =============================================================================
homeassistant {
    # Enable/disable MQTT Discovery
    discovery on;                  # Default: on (true/false, on/off)
    
    # Discovery topic prefix
    discovery_prefix "homeassistant"; # Default: "homeassistant"
    
    # Device grouping strategy:
    # - per_source: each process/service/container = separate device (default)
    # - single: all sensors in one device
    # - hybrid: system metrics in one device, others separate
    device_grouping per_source;    # Default: per_source
    
    # State file for registered sensors (enables stale sensor cleanup)
    # If not set, uses ~/.penguin-metrics/registered_sensors.json
    # state_file "/var/lib/penguin-metrics/registered_sensors.json";
    
    # Default device info (can be overridden per source)
    device {
        # name "My Device";        # Default: auto-generated
        manufacturer "Penguin Metrics"; # Default: None
        model "Linux Monitor";     # Default: None
        # hw_version "1.0";        # Default: None
        # sw_version "0.0.1";      # Default: None
        # suggested_area "Server Room"; # Default: None
        # configuration_url "http://..."; # Default: None
        # via_device "parent_id"; # Default: None
        # identifiers ["id1", "id2"]; # Default: auto-generated
    }
}

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================
logging {
    # Log level: debug, info, warning, error
    level info;                    # Default: info
    
    # Colored console output
    colors on;                     # Default: on (true/false, on/off)
    
    # Log format (Python logging format string)
    # format "%(asctime)s [%(levelname)s] %(name)s: %(message)s"; # Default
    
    # File logging (optional)
    # file "/var/log/penguin-metrics/penguin-metrics.log";
    # file_level debug;            # Log level for file (default: debug)
    # file_max_size 10;            # Max file size in MB (default: 10)
    # file_keep 5;                 # Number of backup files (default: 5)
}

# =============================================================================
# DEFAULT SETTINGS FOR ALL COLLECTORS
# =============================================================================
defaults {
    # Update interval for all collectors
    update_interval 10s;           # Default: 10s (can use: s, m, h, ms, d)
    
    # Enable PSS/USS memory metrics globally (requires root or CAP_SYS_PTRACE)
    smaps off;                     # Default: off (true/false, on/off)
    
    # Enable availability topic for sensors
    availability_topic on;         # Default: on (true/false, on/off)
    
    # =====================================================================
    # PER-SOURCE-TYPE DEFAULTS
    # These override global defaults for specific collector types
    # =====================================================================
    # Note: system defaults are not shown here as system block appears
    # only once in config. Configure system metrics directly in the
    # system block.
    
    # Default settings for process collectors
    process {
        cpu on;                    # Default: on
        memory on;                 # Default: on
        smaps off;                 # Default: None (uses global smaps)
        io off;                    # Default: off
        fds off;                   # Default: off
        threads off;               # Default: off
        aggregate off;             # Default: off
    }
    
    # Default settings for service collectors
    service {
        cpu on;                    # Default: on
        memory on;                 # Default: on
        smaps off;                 # Default: None (uses global smaps)
        state on;                  # Default: on
        restart_count off;         # Default: off
    }
    
    # Default settings for container collectors
    container {
        cpu on;                    # Default: on
        memory on;                 # Default: on
        network off;               # Default: off
        disk off;                  # Default: off
        state on;                  # Default: on
        health off;                # Default: off
        uptime off;                # Default: off
    }
    
    # Default settings for battery collectors
    battery {
        capacity on;               # Default: on
        status on;                 # Default: on (note: always collected as 'state')
        voltage off;                # Default: off
        current off;                # Default: off
        power off;                  # Default: off
        health off;                 # Default: off
        cycles off;                 # Default: off
        temperature off;            # Default: off
        time_to_empty off;          # Default: off
        time_to_full off;           # Default: off
    }
    
    # Default settings for custom collectors
    custom {
        type "number";             # Default: "number" (number, string, json)
        timeout 5s;                # Default: 5s
    }
}

# =============================================================================
# AUTO-DISCOVERY
# =============================================================================
# Auto-discovery finds sensors, batteries, containers, services, and processes
# automatically based on filters. Use plural block names for auto-discovery.

# Auto-discover temperature sensors
temperatures {
    auto on;                       # Default: off (true/false, on/off)
    
    # Temperature sources
    thermal on;                    # /sys/class/thermal (default: on)
    hwmon off;                     # hwmon via psutil (default: off, often duplicates thermal)
    
    # Filter patterns (glob matching, multiple allowed)
    # If filters are specified, only matching sensors are included
    # If no filters, all sensors are included (except excluded)
    # filter "soc*";
    # filter "bigcore*";
    
    # Exclude patterns (glob matching, multiple allowed)
    # exclude "gpu*";
}

# Auto-discover batteries
batteries {
    auto on;                       # Default: off
    # filter "BAT*";
    # exclude "test*";
}

# Auto-discover Docker containers
containers {
    auto on;                       # Default: off
    # filter "myapp-*";            # Only containers matching pattern
    # exclude "test-*";            # Exclude containers matching pattern
}

# Auto-discover systemd services
# WARNING: filter is REQUIRED for services (too many services in system!)
services {
    auto on;                       # Default: off
    filter "docker*";              # REQUIRED - specify filter pattern
    # filter "zigbee2mqtt*";
    # exclude "systemd-*";
}

# Auto-discover processes
# WARNING: filter is REQUIRED for processes (thousands of processes in system!)
processes {
    auto on;                       # Default: off
    filter "python*";              # REQUIRED - specify filter pattern
    # filter "nginx*";
    # exclude "systemd*";
}

# =============================================================================
# SYSTEM METRICS
# =============================================================================
# System-wide metrics (CPU, RAM, swap, load, uptime)
# Topic: {prefix}/system → JSON with all metrics

system {
    # Optional: custom ID for device identification
    # id "my_server";
    
    # Optional: device info override
    # device {
    #     name "My Linux Server";
    #     manufacturer "Dell";
    #     model "PowerEdge R740";
    #     hw_version "1.0";
    #     sw_version "0.0.1";
    # }
    
    # Metrics to collect
    cpu on;                        # Default: on
    cpu_per_core off;              # Default: off (individual core usage)
    memory on;                     # Default: on
    swap on;                       # Default: on
    load on;                       # Default: on
    uptime on;                     # Default: on
    gpu off;                       # Default: off (GPU metrics if available)
    
    # Update interval (overrides defaults.update_interval)
    # update_interval 5s;
}

# =============================================================================
# PROCESS MONITORING
# =============================================================================
# Monitor individual processes or groups of processes
# Topic: {prefix}/process/{name} → JSON with metrics

# Monitor by exact process name (comm)
process "docker" {
    # Optional: custom ID
    # id "docker_daemon";
    
    # Match criteria (required)
    match name "dockerd";          # Match by process name (comm)
    
    # Optional: sensor prefix (legacy, not commonly used)
    # sensor_prefix "docker_";
    
    # Optional: device info
    # device {
    #     name "Docker Daemon";
    #     manufacturer "Docker Inc.";
    # }
    
    # Metrics to collect
    cpu on;                        # Default: on (from defaults.process)
    memory on;                     # Default: on
    smaps on;                      # Default: off (requires root/CAP_SYS_PTRACE)
    io on;                         # Default: off
    fds off;                       # Default: off
    threads on;                    # Default: off
    aggregate off;                 # Default: off (sum metrics if multiple matches)
    
    # Update interval (overrides defaults.update_interval)
    # update_interval 5s;
}

# Monitor by regex pattern on command line
process "nginx-workers" {
    match pattern "nginx: worker"; # Regex pattern matching cmdline
    
    cpu on;
    memory on;
    aggregate on;                  # Sum metrics from all matching processes
}

# Monitor by exact PID
# process "my-app" {
#     match pid 12345;
#     cpu on;
#     memory on;
# }

# Monitor by PID file
# process "my-app" {
#     match pidfile "/var/run/my-app.pid";
#     cpu on;
#     memory on;
#     smaps on;
# }

# Monitor by command line substring
# process "python-app" {
#     match cmdline "/opt/myapp/main.py";
#     cpu on;
#     memory on;
# }

# =============================================================================
# SYSTEMD SERVICE MONITORING
# =============================================================================
# Monitor systemd services (aggregates metrics from all service processes)
# Topic: {prefix}/service/{name} → JSON with metrics

service "docker-service" {
    # Optional: custom ID
    # id "docker_service";
    
    # Match criteria (required)
    match unit "docker.service";  # Exact unit name
    
    # Optional: device info
    # device {
    #     name "Docker Service";
    # }
    
    # Metrics to collect
    cpu on;                        # Default: on (from defaults.service)
    memory on;                     # Default: on
    smaps on;                      # Default: off (aggregates PSS/USS across all processes)
    state on;                      # Default: on (active/inactive/failed)
    restart_count on;              # Default: off
    
    # Update interval (overrides defaults.update_interval)
    # update_interval 5s;
}

# Monitor by pattern (first match)
# service "nginx" {
#     match pattern "nginx*.service";
#     cpu on;
#     memory on;
#     state on;
# }

# =============================================================================
# DOCKER CONTAINER MONITORING
# =============================================================================
# Monitor Docker containers via Docker API
# Topic: {prefix}/docker/{name} → JSON with metrics

container "homeassistant" {
    # Optional: custom ID
    # id "ha_container";
    
    # Match criteria (required)
    match name "homeassistant";    # Match by container name
    
    # Optional: device info
    # device {
    #     name "Home Assistant";
    #     manufacturer "Home Assistant";
    # }
    
    # Metrics to collect
    cpu on;                        # Default: on (from defaults.container)
    memory on;                     # Default: on
    network on;                    # Default: off
    disk on;                       # Default: off
    state on;                      # Default: on (running/exited/paused)
    health on;                     # Default: off (requires healthcheck)
    uptime on;                     # Default: off
    
    # Update interval (overrides defaults.update_interval)
    # update_interval 5s;
}

# Monitor by image name
# container "postgres" {
#     match image "postgres:";
#     cpu on;
#     memory on;
#     state on;
# }

# Monitor by label
# container "monitored" {
#     match label "metrics.enabled=true";
#     cpu on;
#     memory on;
#     state on;
# }

# =============================================================================
# BATTERY MONITORING
# =============================================================================
# Monitor battery status from /sys/class/power_supply/
# Topic: {prefix}/battery/{name} → JSON with metrics

battery "main" {
    # Optional: custom ID
    # id "main_battery";
    
    # Auto-detect or specify path/name
    # path "/sys/class/power_supply/BAT0";
    # name "BAT0";
    
    # Optional: device info
    # device {
    #     name "Laptop Battery";
    # }
    
    # Metrics to collect
    capacity on;                   # Default: on (charge percentage)
    status on;                     # Default: on (charging/discharging/full, collected as 'state')
    voltage off;                   # Default: off
    current off;                    # Default: off
    power off;                     # Default: off
    health off;                    # Default: off
    cycles off;                    # Default: off
    temperature off;               # Default: off
    time_to_empty off;             # Default: off
    time_to_full off;              # Default: off
    
    # Update interval (overrides defaults.update_interval)
    # update_interval 30s;
}

# =============================================================================
# TEMPERATURE SENSORS (Manual Configuration)
# =============================================================================
# Manually configure specific temperature sensors
# Overrides auto-discovered sensors with the same name
# Topic: {prefix}/temperature/{name} → JSON: {"temp": 42.0, "state": "online"}

# Monitor specific thermal zone
temperature "cpu" {
    # Optional: custom ID
    # id "cpu_temp";
    
    # Match by thermal zone type or name
    zone "cpu-thermal";            # Thermal zone type/name
    
    # Or specify direct path
    # path "/sys/class/thermal/thermal_zone0/temp";
    
    # Or specify hwmon sensor
    # hwmon "soc_thermal_sensor0"; # hwmon sensor name
    
    # Optional: device info
    # device {
    #     name "CPU Temperature";
    # }
    
    # Update interval (overrides defaults.update_interval)
    # update_interval 5s;
}

# =============================================================================
# CUSTOM SENSORS
# =============================================================================
# Execute custom commands or scripts
# Topic: {prefix}/custom/{name} → JSON: {"value": ..., "state": "online"}

# Read 1-Wire temperature sensor
custom "room_temp" {
    # Optional: custom ID
    id "room_temperature";
    
    # Command to execute
    command "cat /sys/bus/w1/devices/28-*/temperature";
    
    # Or use script file
    # script "/opt/scripts/check_disk.sh";
    
    # Output type
    type number;                   # Default: "number" (number, string, json)
    
    # Unit of measurement
    unit "°C";
    
    # Scale factor (multiply result)
    scale 0.001;                   # Default: 1.0
    
    # Home Assistant configuration
    device_class temperature;      # Default: None
    state_class measurement;       # Default: None
    # icon "mdi:thermometer";     # Default: None
    
    # Optional: device info
    # device {
    #     name "Room Temperature";
    # }
    
    # Update interval (overrides defaults.update_interval)
    update_interval 30s;
    
    # Command timeout
    timeout 5s;                    # Default: 5s (from defaults.custom)
}

# Get external IP (string type)
# custom "wan_ip" {
#     command "curl -s ifconfig.me";
#     type string;
#     update_interval 5m;
# }

# Run custom script returning JSON
# custom "disk_health" {
#     script "/opt/scripts/check_disk.sh";
#     type json;
#     update_interval 1h;
# }

# =============================================================================
# GPU MONITORING
# =============================================================================
# Monitor GPU metrics (minimal implementation)
# Topic: {prefix}/gpu/{name} → JSON with metrics

# gpu "primary" {
#     # Optional: custom ID
#     # id "main_gpu";
#     
#     # Optional: device info
#     # device {
#     #     name "GPU";
#     #     manufacturer "NVIDIA";
#     # }
#     
#     # Update interval (overrides defaults.update_interval)
#     # update_interval 10s;
# }

# =============================================================================
# INCLUDE OTHER CONFIG FILES
# =============================================================================
# Include additional configuration files
# Useful for splitting config into multiple files

# include "/etc/penguin-metrics/conf.d/*.conf";
# include "/etc/penguin-metrics/processes.conf";
# include "/etc/penguin-metrics/containers.conf";
