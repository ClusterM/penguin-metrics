# Penguin Metrics Configuration
# Linux system telemetry for Home Assistant via MQTT
#
# Nginx-like syntax with blocks and directives.
# Supports includes: include "/path/to/other.conf";
#
# All options are documented with default values and explanations.

# =============================================================================
# AUTO-REFRESH (Top-level setting)
# =============================================================================
# Periodically check for new/removed services, containers, and processes.
# When enabled, automatically adds new sources matching filters and removes
# disappeared sources. Home Assistant sensors are updated dynamically.
# Default: 0 (disabled)
# auto_refresh_interval 60s;

# =============================================================================
# MQTT BROKER CONNECTION
# =============================================================================
mqtt {
    # Broker address (required)
    host "localhost";              # Default: "localhost"
    port 1883;                     # Default: 1883
    
    # Authentication (optional)
    # username "user";             # Default: None (no auth)
    # password "pass";             # Default: None (no auth)
    
    # Client identification
    # client_id "penguin_metrics"; # Default: auto-generated (hostname-based)
    
    # Topic configuration
    topic_prefix "penguin_metrics"; # Default: "penguin_metrics"
    qos 1;                         # Default: 1 (0, 1, or 2)
    
    # Message retention
    # - off: don't retain any messages
    # - on:  retain all messages (default)
    retain on;                     # Default: on
    
    # Connection keepalive
    keepalive 60;                   # Default: 60 seconds
}

# =============================================================================
# HOME ASSISTANT INTEGRATION
# =============================================================================
homeassistant {
    # Enable/disable MQTT Discovery
    discovery on;                  # Default: on (true/false, on/off)
    
    # Discovery topic prefix
    discovery_prefix "homeassistant"; # Default: "homeassistant"
    
    # State file for registered sensors (enables stale sensor cleanup)
    # If not set, uses ~/.penguin-metrics/registered_sensors.json
    # state_file "/var/lib/penguin-metrics/registered_sensors.json";
}

# =============================================================================
# DEVICE TEMPLATES
# =============================================================================
# Define reusable device templates for grouping sensors in Home Assistant.
# Sensors can reference these templates using `device "template_name";`
#
# Reserved device references:
# - device system;  -- group with the system device (default for temp, GPU, disks, battery)
# - device auto;    -- create a dedicated device (default for services, containers, processes, custom)
# - device none;    -- no device ("orphan" entity)

# Example: UPS batteries device template
device "ups_batteries" {
    name "UPS Batteries";
    manufacturer "APC";
    model "Smart-UPS";
    # hw_version "1.0";
    # sw_version "0.0.1";
}

# Example: Custom monitoring device
# device "room_sensors" {
#     name "Room Sensors";
#     manufacturer "Penguin Metrics";
#     model "Environmental Monitor";
# }

# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================
logging {
    # Log level: debug, info, warning, error
    level info;                    # Default: info
    
    # Colored console output
    colors on;                     # Default: on (true/false, on/off)
    
    # Log format (Python logging format string)
    # format "%(asctime)s [%(levelname)s] %(name)s: %(message)s"; # Default
    
    # File logging (optional)
    # file "/var/log/penguin-metrics/penguin-metrics.log";
    # file_level debug;            # Log level for file (default: debug)
    # file_max_size 10;            # Max file size in MB (default: 10)
    # file_keep 5;                 # Number of backup files (default: 5)
}

# =============================================================================
# DEFAULT SETTINGS FOR ALL COLLECTORS
# =============================================================================
defaults {
    # Update interval for all collectors
    update_interval 10s;           # Default: 10s (can use: s, m, h, ms, d)
    
    # Enable PSS/USS memory metrics globally (requires root or CAP_SYS_PTRACE)
    smaps off;                     # Default: off (true/false, on/off)
    
    # =====================================================================
    # PER-SOURCE-TYPE DEFAULTS
    # These override global defaults for specific collector types
    # =====================================================================
    # Note: system defaults are not shown here as system block appears
    # only once in config. Configure system metrics directly in the
    # system block.
    
    # Default settings for process collectors
    process {
        cpu on;                    # Default: on
        memory on;                 # Default: on
        smaps off;                 # Default: None (uses global smaps)
        disk off;                  # Default: off (read/write totals, MiB)
        disk_rate off;             # Default: off (MiB/s)
        fds off;                   # Default: off
        threads off;               # Default: off
        aggregate off;             # Default: off
    }
    
    # Default settings for service collectors
    service {
        cpu on;                    # Default: on
        memory on;                 # Default: on
        smaps off;                 # Default: None (uses global smaps)
        state on;                  # Default: on
        restart_count off;         # Default: off
        disk off;                  # Default: off (read/write totals, MiB)
        disk_rate off;             # Default: off (MiB/s)
    }
    
    # Default settings for container collectors
    container {
        cpu on;                    # Default: on
        memory on;                 # Default: on
        network off;               # Default: off (total bytes)
        network_rate off;          # Default: off (KB/s)
        disk off;                  # Default: off (total bytes)
        disk_rate off;             # Default: off (KB/s)
        state on;                  # Default: on
        health off;                # Default: off (returns "n/a" if no healthcheck)
        uptime off;                # Default: off
    }
    
    # Default settings for battery collectors
    battery {
        capacity on;               # Default: on
        voltage off;               # Default: off
        current off;               # Default: off
        power off;                 # Default: off
        health off;                # Default: off
        energy_now on;             # Default: on (Wh)
        energy_full on;            # Default: on (Wh)
        energy_full_design on;     # Default: on (Wh)
        cycles off;                # Default: off
        temperature off;           # Default: off
        time_to_empty off;         # Default: off
        time_to_full off;          # Default: off
        present off;               # Default: off (battery presence flag)
        technology off;            # Default: off (battery chemistry, e.g., Li-ion)
        voltage_max off;           # Default: off (current max voltage)
        voltage_min off;           # Default: off (current min voltage)
        voltage_max_design off;    # Default: off (design max voltage)
        voltage_min_design off;    # Default: off (design min voltage)
        constant_charge_current off;      # Default: off (target charge current)
        constant_charge_current_max off;  # Default: off (max charge current)
        charge_full_design off;    # Default: off (design full charge, mAh)
    }
    
    # Default settings for custom collectors
    custom {
        type "number";             # Default: "number" (number, string, json)
        timeout 5s;                # Default: 5s
    }
    
    # Default settings for disk collectors
    disk {
        total on;                  # Default: on (total size in GB)
        used on;                   # Default: on (used space in GB)
        free on;                   # Default: on (free space in GB)
        percent on;                # Default: on (usage percentage)
    }
}

# =============================================================================
# AUTO-DISCOVERY
# =============================================================================
# Auto-discovery finds sensors, batteries, containers, services, and processes
# automatically based on filters. Use plural block names for auto-discovery.
# Notes:
# - Auto blocks inherit per-source defaults (see defaults{} above)
# - Boolean flags inside auto blocks override those defaults
# - update_interval inside an auto block overrides interval for auto-created items only

# Auto-discover temperature sensors
temperatures {
    auto on;                       # Default: off (true/false, on/off)
    source thermal;                # "thermal" or "hwmon" (default: thermal)
    
    # Device for all auto-discovered sensors:
    # device system;               # Group with system device (default)
    # device auto;                 # Create dedicated device per sensor
    # device "my_template";        # Use a device template
    
    # Filter patterns (glob matching, multiple allowed)
    # If filters are specified, only matching sensors are included
    # If no filters, all sensors are included (except excluded)
    # filter "soc*";
    # filter "bigcore*";
    
    # Exclude patterns (glob matching, multiple allowed)
    # exclude "gpu*";

    # Optional overrides
    # update_interval 15s;          # Override interval for auto temperatures
}

# Auto-discover batteries
batteries {
    auto on;                       # Default: off
    # device system;               # Group with system device (default)
    # filter "BAT*";
    # exclude "test*";

    # Optional overrides (inherit defaults.battery first)
    # current off;                  # Disable current metric for auto batteries
    # temperature on;               # Enable temperature metric
    # update_interval 30s;          # Override interval for auto batteries
}

# Auto-discover external power supplies (non-battery)
ac_powers {
    auto off;                      # Default: off
    # device system;               # Group with system device (default via parent device)
    # filter "axp*";               # Match by power_supply name
    # exclude "usb*";              # Exclude specific supplies

    # Optional overrides
    # update_interval 30s;         # Override interval for auto AC power
}

# Auto-discover Docker containers
containers {
    auto on;                       # Default: off
    # device auto;                 # Create dedicated device per container (default)
    # device system;               # Group all with system device
    # filter "myapp-*";            # Only containers matching pattern
    # exclude "test-*";            # Exclude containers matching pattern

    # Optional overrides (inherit defaults.container first)
    # disk_rate on;                 # Enable disk rate metrics for auto containers
    # update_interval 10s;          # Override interval for auto containers
}

# Auto-discover systemd services
# WARNING: filter is REQUIRED for services (too many services in system!)
services {
    auto on;                       # Default: off
    # device auto;                 # Create dedicated device per service (default)
    filter "docker*";              # REQUIRED - specify filter pattern
    # filter "zigbee2mqtt*";
    # exclude "systemd-*";

    # Optional overrides (inherit defaults.service first)
    # smaps on;                     # Enable PSS/USS for auto services
    # update_interval 10s;          # Override interval for auto services
}

# Auto-discover processes
# WARNING: filter is REQUIRED for processes (thousands of processes in system!)
processes {
    auto on;                       # Default: off
    # device auto;                 # Create dedicated device per process (default)
    filter "python*";              # REQUIRED - specify filter pattern
    # filter "nginx*";
    # exclude "systemd*";

    # Optional overrides (inherit defaults.process first)
    # smaps on;                     # Enable PSS/USS for auto processes
    # update_interval 10s;          # Override interval for auto processes
}

# Auto-discover disk partitions
disks {
    auto on;                       # Default: off
    # device system;               # Group with system device (default)
    filter "*";                    # All partitions (or use specific patterns)
    # filter "nvme*";              # Only NVMe partitions
    # filter "sd*";                # Only SATA/SCSI disks
    # exclude "loop*";             # Exclude loop devices (already excluded by default)

    # Optional overrides (inherit defaults.disk first)
    # free off;                     # Disable free metric for auto disks
    # update_interval 60s;          # Override interval for auto disks
}

# =============================================================================
# SYSTEM METRICS
# =============================================================================
# System-wide metrics (CPU, RAM, swap, load, uptime)
# Topic: {prefix}/system → JSON with all metrics

system {
    # By default, device info is auto-detected from the system:
    # - Name: hostname
    # - Manufacturer: from DMI/device-tree (Dell, Orange Pi, Raspberry Pi, etc.)
    # - Model: from DMI/device-tree or OS name
    # - SW Version: kernel version
    #
    # To override, use a device template:
    # device "my_server_template";
    
    # Metrics to collect
    cpu on;                        # Default: on
    cpu_per_core off;              # Default: off (individual core usage)
    memory on;                     # Default: on
    swap on;                       # Default: on
    load on;                       # Default: on
    uptime on;                     # Default: on
    gpu off;                       # Default: off (GPU metrics if available)
    
    # Update interval (overrides defaults.update_interval)
    # update_interval 5s;
}

# =============================================================================
# PROCESS MONITORING
# =============================================================================
# Monitor individual processes or groups of processes
# Topic: {prefix}/process/{name} → JSON with metrics

# Monitor by exact process name (comm)
process "docker" {
    # Match criteria (required)
    match name "dockerd";          # Match by process name (comm)
    
    # Optional: sensor prefix (legacy, not commonly used)
    # sensor_prefix "docker_";
    
    # Device grouping options:
    # device auto;                 # Create dedicated device (default for processes)
    # device system;               # Group with system device
    # device none;                 # No device (orphan entity)
    # device "template_name";      # Use a device template
    
    # Metrics to collect
    cpu on;                        # Default: on (from defaults.process)
    memory on;                     # Default: on
    smaps on;                      # Default: off (requires root/CAP_SYS_PTRACE)
    disk on;                       # Default: off (read/write totals, MiB)
    disk_rate on;                  # Default: off (MiB/s)
    fds off;                       # Default: off
    threads on;                    # Default: off
    aggregate off;                 # Default: off (sum metrics if multiple matches)
    
    # Update interval (overrides defaults.update_interval)
    # update_interval 5s;
}

# Monitor by regex pattern on command line
process "nginx-workers" {
    match pattern "nginx: worker"; # Regex pattern matching cmdline
    
    cpu on;
    memory on;
    aggregate on;                  # Sum metrics from all matching processes
}

# Monitor by exact PID
# process "my-app" {
#     match pid 12345;
#     cpu on;
#     memory on;
# }

# Monitor by PID file
# process "my-app" {
#     match pidfile "/var/run/my-app.pid";
#     cpu on;
#     memory on;
#     smaps on;
# }

# Monitor by command line substring
# process "python-app" {
#     match cmdline "/opt/myapp/main.py";
#     cpu on;
#     memory on;
# }

# =============================================================================
# SYSTEMD SERVICE MONITORING
# =============================================================================
# Monitor systemd services (aggregates metrics from all service processes)
# Topic: {prefix}/service/{name} → JSON with metrics

service "docker-service" {
    # Match criteria (required)
    match unit "docker.service";  # Exact unit name
    
    # Device grouping options:
    # device auto;                 # Create dedicated device (default for services)
    # device system;               # Group with system device
    # device none;                 # No device (orphan entity)
    # device "template_name";      # Use a device template
    
    # Metrics to collect
    cpu on;                        # Default: on (from defaults.service)
    memory on;                     # Default: on (cgroup memory, includes cache)
    smaps on;                      # Default: off (PSS/USS - accurate RAM usage)
    state on;                      # Default: on (active/inactive/failed)
    restart_count on;              # Default: off
    disk on;                       # Default: off (read/write totals, MiB)
    disk_rate on;                  # Default: off (MiB/s)
    
    # Update interval (overrides defaults.update_interval)
    # update_interval 5s;
}

# Monitor by pattern (first match)
# service "nginx" {
#     match pattern "nginx*.service";
#     cpu on;
#     memory on;
#     state on;
# }

# =============================================================================
# DOCKER CONTAINER MONITORING
# =============================================================================
# Monitor Docker containers via Docker API
# Topic: {prefix}/docker/{name} → JSON with metrics

container "homeassistant" {
    # Match criteria (required)
    match name "homeassistant";    # Match by container name
    
    # Device grouping options:
    # device auto;                 # Create dedicated device (default for containers)
    # device system;               # Group with system device
    # device none;                 # No device (orphan entity)
    # device "template_name";      # Use a device template
    
    # Metrics to collect
    cpu on;                        # Default: on (from defaults.container)
    memory on;                     # Default: on
    network on;                    # Default: off (total MiB)
    network_rate off;              # Default: off (MiB/s speed)
    disk on;                       # Default: off (total MiB)
    disk_rate off;                 # Default: off (MiB/s speed)
    state on;                      # Default: on (running/exited/paused)
    health on;                     # Default: off (returns "n/a" if no healthcheck)
    uptime on;                     # Default: off
    
    # Update interval (overrides defaults.update_interval)
    # update_interval 5s;
}

# Monitor by image name
# container "postgres" {
#     match image "postgres:";
#     cpu on;
#     memory on;
#     state on;
# }

# Monitor by label
# container "monitored" {
#     match label "metrics.enabled=true";
#     cpu on;
#     memory on;
#     state on;
# }

# =============================================================================
# BATTERY MONITORING
# =============================================================================
# Monitor battery status from /sys/class/power_supply/
# Topic: {prefix}/battery/{name} → JSON with metrics

battery "ups_battery_1" {
    # Use the "ups_batteries" device template defined above
    device "ups_batteries";
    
    # Auto-detect or specify path/name
    # path "/sys/class/power_supply/BAT0";
    # name "BAT0";
    
    # Device grouping options:
    # device system;               # Group with system device (default for batteries)
    # device auto;                 # Create dedicated device
    # device none;                 # No device (orphan entity)
    # device "template_name";      # Use a device template
    
    # Metrics to collect
    capacity on;                   # Default: on (charge percentage)
    voltage on;                    # Default: on
    current on;                    # Default: on
    power on;                      # Default: on
    health on;                     # Default: on
    cycles off;                    # Default: off
    temperature off;               # Default: off
    time_to_empty off;             # Default: off
    time_to_full off;              # Default: off
    present off;                   # Default: off (battery presence flag)
    technology off;                # Default: off (battery chemistry)
    voltage_max off;               # Default: off (current max voltage)
    voltage_min off;               # Default: off (current min voltage)
    voltage_max_design off;        # Default: off (design max voltage)
    voltage_min_design off;        # Default: off (design min voltage)
    constant_charge_current off;   # Default: off (target charge current)
    constant_charge_current_max off; # Default: off (max charge current)
    charge_full_design off;        # Default: off (design full charge, mAh)
    
    # Update interval (overrides defaults.update_interval)
    # update_interval 30s;
}

# =============================================================================
# AC POWER (External power supply)
# =============================================================================
# Monitor external power (mains) from /sys/class/power_supply/<device>/online
# Topic: {prefix}/ac_power/{block_name} → JSON: {"state": "online"|"not_found", "online": true|false}
# Block name = collector ID (topic). Use "name" for sysfs device, or "path" for full path.

# ac_power "axp22x-ac" {
#     device system;                # Group with system device (default)
#     # name "axp22x-ac";           # Sysfs device name (default: same as block name)
#     # path "/sys/class/power_supply/axp22x-ac";  # Optional: full path (overrides name)
#     # update_interval 30s;
#     # homeassistant { name "AC Power"; icon "mdi:power-plug"; }
# }

# Friendly block name with explicit device name:
# ac_power "main" {
#     name "axp22x-ac";             # Read from /sys/class/power_supply/axp22x-ac
#     device system;
# }

# =============================================================================
# DISK SPACE MONITORING
# =============================================================================
# Monitor disk space usage from mounted partitions
# Topic: {prefix}/disk/{name} → JSON with metrics
# Uses psutil.disk_usage() for statistics

disk "root" {
    # Specify device path (sda1, nvme0n1p1) or mountpoint
    path "sda1";                   # Device name (from /dev/)
    # mountpoint "/";              # Or use mountpoint instead
    
    # Device grouping options:
    # device system;               # Group with system device (default for disks)
    # device auto;                 # Create dedicated device
    # device none;                 # No device (orphan entity)
    # device "template_name";      # Use a device template
    
    # Metrics to collect
    total on;                      # Default: on (total size in GiB)
    used on;                       # Default: on (used space in GiB)
    free on;                       # Default: on (free space in GiB)
    percent on;                    # Default: on (usage percentage)
    
    # Update interval (overrides defaults.update_interval)
    # update_interval 60s;
}

# Monitor NVMe partition
# disk "nvme_data" {
#     path "nvme0n1p2";
#     total on;
#     used on;
#     free on;
#     percent on;
# }

# Monitor by mountpoint
# disk "home" {
#     mountpoint "/home";
#     percent on;
# }

# =============================================================================
# TEMPERATURE SENSORS (Manual Configuration)
# =============================================================================
# Manually configure specific temperature sensors
# Overrides auto-discovered sensors with the same name
# Topic: {prefix}/temperature/{name} → JSON: {"temp": 42.0, "state": "online"}

# Monitor specific thermal zone
temperature "cpu" {
    # Optional: custom ID
    # id "cpu_temp";
    
    # Match by thermal zone type or name
    zone "cpu-thermal";            # Thermal zone type/name
    
    # Or specify direct path
    # path "/sys/class/thermal/thermal_zone0/temp";
    
    # Or specify hwmon sensor
    # hwmon "soc_thermal_sensor0"; # hwmon sensor name
    
    # Device grouping options:
    # device system;               # Group with system device (default for temperature)
    # device auto;                 # Create dedicated device
    # device none;                 # No device (orphan entity)
    # device "template_name";      # Use a device template
    
    # Update interval (overrides defaults.update_interval)
    # update_interval 5s;
}

# =============================================================================
# CUSTOM SENSORS
# =============================================================================
# Execute custom commands or scripts
# Topic: {prefix}/custom/{name} → JSON: {"value": ..., "state": "online"}

# Read 1-Wire temperature sensor
# The block name ("room_temp") is the sensor ID, used for MQTT topics
custom "room_temp" {
    # Command to execute
    command "cat /sys/bus/w1/devices/28-*/temperature";
    
    # Or use script file
    # script "/opt/scripts/check_disk.sh";
    
    # Output type
    type number;                   # Default: "number" (number, string, json)
    
    # Scale factor (multiply result)
    scale 0.001;                   # Default: 1.0
    
    # Home Assistant sensor overrides
    homeassistant {
        name "Room Temperature";   # Display name in HA (default: use ID)
        icon "mdi:thermometer";
        unit_of_measurement "°C";
        device_class temperature;
        state_class measurement;
        # Any other HA discovery fields can be added here
    }
    
    # Device grouping options:
    # device auto;                 # Create dedicated device (default for custom)
    # device system;               # Group with system device
    # device none;                 # No device (orphan entity)
    # device "room_sensors";       # Use a device template
    
    # Update interval (overrides defaults.update_interval)
    update_interval 30s;
    
    # Command timeout
    timeout 5s;                    # Default: 5s (from defaults.custom)
}

# Get external IP (string type)
# custom "wan_ip" {
#     command "curl -s ifconfig.me";
#     type string;
#     update_interval 5m;
# }

# Run custom script returning JSON
# custom "disk_health" {
#     script "/opt/scripts/check_disk.sh";
#     type json;
#     update_interval 1h;
# }

# =============================================================================
# CUSTOM BINARY SENSORS
# =============================================================================
# Binary sensors (ON/OFF states) for command execution results
# Topic: {prefix}/custom_binary/{name} → JSON: {"state": "ON"|"OFF", "state": "online"}

# Ping check (returns ON if host is reachable, OFF if not)
# The block name ("server_ping") is the sensor ID, used for MQTT topics
custom_binary "server_ping" {
    # Command to execute
    command "ping -c 1 -W 1 8.8.8.8 > /dev/null 2>&1";
    
    # Or use script file
    # script "/opt/scripts/check_service.sh";
    
    # Value source: how to interpret the result
    value_source returncode;         # Default: "returncode" (0=ON, non-zero=OFF)
    # value_source output;          # Alternative: parse command output (ON/OFF patterns)
    
    # Invert the value (ON ↔ OFF)
    # invert on;                     # Default: off
    
    # Home Assistant sensor overrides
    homeassistant {
        name "Server Reachability";  # Display name in HA (default: use ID)
        icon "mdi:network";
        device_class connectivity;   # Optional: connectivity, motion, etc.
        # Any other HA discovery fields can be added here
    }
    
    # Device grouping options:
    # device auto;                 # Create dedicated device (default for custom_binary)
    # device system;               # Group with system device
    # device none;                 # No device (orphan entity)
    # device "network_monitors";   # Use a device template
    
    # Update interval (overrides defaults.update_interval)
    update_interval 30s;
    
    # Command timeout
    timeout 5s;                    # Default: 5s
}

# Check if service is running (using output parsing)
# custom_binary "nginx_running" {
#     command "systemctl is-active nginx";
#     value_source output;          # Parse output: "active" = ON, other = OFF
#     update_interval 10s;
# }

# =============================================================================
# GPU MONITORING
# =============================================================================
# Monitor GPU metrics (minimal implementation)
# Topic: {prefix}/gpu/{name} → JSON with metrics

# gpu "primary" {
#     # Optional: device info
#     # device {
#     #     name "GPU";
#     #     manufacturer "NVIDIA";
#     # }
#     
#     # Update interval (overrides defaults.update_interval)
#     # update_interval 10s;
# }

# =============================================================================
# INCLUDE OTHER CONFIG FILES
# =============================================================================
# Include additional configuration files
# Useful for splitting config into multiple files

# include "/etc/penguin-metrics/conf.d/*.conf";
# include "/etc/penguin-metrics/processes.conf";
# include "/etc/penguin-metrics/containers.conf";
