# Penguin Metrics Configuration
# Linux system telemetry for Home Assistant via MQTT
#
# Nginx-like syntax with blocks and directives.
# Supports includes: include "/path/to/other.conf";

# MQTT broker connection
mqtt {
    host "10.13.1.100";
    port 1883;
    username "penguin_metrics";
    password "password";
    
    # Optional settings
    # client_id "penguin_metrics_server1";  # Auto-generated if not set
    topic_prefix "penguin_metrics";
    qos 1;
    
    # Retain modes:
    # - off:    don't retain any messages
    # - online: only retain availability status (LWT) - default
    # - full:   retain all messages
    retain online;
}

# Home Assistant integration
homeassistant {
    discovery on;
    discovery_prefix "homeassistant";
    
    # Device grouping strategy:
    # - per_source: each process/service/container = separate device
    # - single: all sensors in one device
    # - hybrid: system metrics in one device, others separate
    device_grouping per_source;
    
    # Default device info (can be overridden per source)
    device {
        manufacturer "Penguin Metrics";
        model "Linux Monitor";
    }
}

# Default settings for all collectors
defaults {
    update_interval 10s;
    smaps off;                 # Enable PSS/USS memory metrics (requires root)
    availability_topic on;
    
    # Per-source-type defaults (override global defaults for specific types)
    
    # Default settings for all process monitors
    process {
        cpu on;
        memory on;
        smaps off;             # Override with 'on' to enable smaps for all processes
        io off;
        fds off;
        threads off;
        aggregate off;
    }
    
    # Default settings for all container monitors
    container {
        cpu on;
        memory on;
        network off;
        disk off;
        state on;
        health off;
        uptime off;
    }
    
    # Other type defaults available: service, battery, custom, system
}

# Logging configuration
logging {
    level info;                # debug, info, warning, error
    colors on;                 # Colored console output
    
    # File logging (optional)
    # file "/var/log/penguin-metrics/penguin-metrics.log";
    # file_level debug;        # Log level for file
    # file_max_size 10;        # Max file size in MB
    # file_keep 5;             # Number of backup files
}

# =============================================================================
# AUTO-DISCOVERY (optional - discover sensors automatically)
# =============================================================================

# Auto-discover all temperature sensors
temperatures {
    auto on;
    # filter "nvme_*";           # Only sensors matching pattern
    # exclude "internal*";       # Exclude sensors matching pattern
}

# Auto-discover all batteries
batteries {
    auto on;
}

# Auto-discover running Docker containers
# containers {
#     auto on;
#     filter "myapp-*";          # Only containers matching pattern
#     exclude "test-*";          # Exclude containers matching pattern
# }

# Auto-discover systemd services (requires filter!)
# services {
#     auto on;
#     filter "docker*";          # REQUIRED - too many services otherwise
# }

# =============================================================================
# SYSTEM METRICS
# =============================================================================

system "main" {
    # Optional: custom ID for MQTT topics
    # id "my_server";
    
    # Optional: device info override
    # device {
    #     name "My Linux Server";
    #     manufacturer "Dell";
    #     model "PowerEdge R740";
    # }
    
    cpu on;
    cpu_per_core off;          # Individual core usage (can be noisy)
    memory on;
    swap on;
    load on;
    uptime on;
    gpu off;                   # GPU metrics (if available)
    
    # Note: temperature sensors are now configured via:
    #   temperatures { auto on; }
    # See AUTO-DISCOVERY section above
    
    update_interval 5s;
}

# =============================================================================
# PROCESS MONITORING
# =============================================================================

# Monitor Docker daemon by exact name
process "docker" {
    match name "dockerd";
    
    cpu on;
    memory on;
    smaps on;                  # Enable PSS/USS (may need root)
    io on;
    threads on;
    
    device {
        name "Docker Daemon";
    }
}

# Monitor Nginx workers by regex pattern (aggregated)
# process "nginx-workers" {
#     match pattern "nginx: worker";
#     aggregate on;              # Sum metrics from all matching processes
#     
#     cpu on;
#     memory on;
# }

# Monitor by PID file
# process "my-app" {
#     match pidfile "/var/run/my-app.pid";
#     
#     cpu on;
#     memory on;
#     smaps on;
# }

# Monitor by command line substring
# process "python-app" {
#     match cmdline "/opt/myapp/main.py";
#     
#     cpu on;
#     memory on;
# }

# =============================================================================
# SYSTEMD SERVICE MONITORING
# =============================================================================

# Monitor Docker service
# service "docker" {
#     match unit "docker.service";
#     
#     cpu on;
#     memory on;
#     smaps on;                  # Aggregate PSS across all service processes
#     state on;
#     restart_count on;
#     
#     device {
#         name "Docker Service";
#     }
# }

# Monitor by pattern (first match)
# service "nginx" {
#     match pattern "nginx*.service";
#     
#     cpu on;
#     memory on;
#     state on;
# }

# =============================================================================
# DOCKER CONTAINER MONITORING
# =============================================================================

# Monitor Home Assistant container
# container "homeassistant" {
#     match name "homeassistant";
#     
#     cpu on;
#     memory on;
#     network on;
#     disk on;
#     state on;
#     health on;                 # Requires healthcheck in container
#     uptime on;
#     
#     device {
#         name "Home Assistant";
#     }
# }

# Monitor by image name
# container "postgres" {
#     match image "postgres:";
#     
#     cpu on;
#     memory on;
#     state on;
# }

# Monitor by label
# container "monitored" {
#     match label "metrics.enabled=true";
#     
#     cpu on;
#     memory on;
#     state on;
# }

# =============================================================================
# BATTERY MONITORING
# =============================================================================

# Monitor laptop battery
# battery "main" {
#     # Auto-detect or specify:
#     # path "/sys/class/power_supply/BAT0";
#     # name "BAT0";
#     
#     capacity on;               # Percentage
#     status on;                 # Charging/discharging/full
#     voltage on;
#     current on;
#     power on;
#     health on;
#     cycles on;
#     temperature on;
#     time_to_empty on;
#     time_to_full on;
#     
#     update_interval 30s;
# }

# =============================================================================
# TEMPERATURE ZONES (standalone)
# =============================================================================

# Monitor specific thermal zone (overrides auto-discovered)
# temperature "cpu" {
#     zone "cpu-thermal";        # Or: path "/sys/class/thermal/thermal_zone0/temp"
#     update_interval 5s;
# }

# =============================================================================
# CUSTOM SENSORS
# =============================================================================

# Read 1-Wire temperature sensor
# custom "room_temp" {
#     id "room_temperature";
#     command "cat /sys/bus/w1/devices/28-*/temperature";
#     
#     type number;               # number, string, json
#     unit "Â°C";
#     scale 0.001;               # Multiply result by this
#     
#     device_class temperature;
#     state_class measurement;
#     
#     update_interval 30s;
#     timeout 5s;
# }

# Get external IP
# custom "wan_ip" {
#     command "curl -s ifconfig.me";
#     type string;
#     update_interval 5m;
# }

# Run custom script
# custom "disk_health" {
#     script "/opt/scripts/check_disk.sh";
#     type number;
#     update_interval 1h;
# }

# =============================================================================
# INCLUDE OTHER CONFIG FILES
# =============================================================================

# include "/etc/penguin-metrics/conf.d/*.conf";
# include "/etc/penguin-metrics/processes.conf";
